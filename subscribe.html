<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscribe - Priyam Alok</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@400;600&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Source Serif 4', serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .link-style { color: #d9534f; text-decoration: none; transition: color .2s ease-in-out; }
        .link-style:hover { text-decoration: underline; text-decoration-color: #f0c3c2; text-underline-offset: 2px; }
        .nav-link { font-family: 'Source Sans 3', sans-serif; text-decoration: none; transition: color .2s ease-in-out; color: #d9534f; }
        .nav-link:hover { color: #bf4340; }
        h1, .page-title, .post-title { font-family: 'Source Sans 3', sans-serif; font-weight: 600; }

        /* Custom styles for the tag pills */
        .tag-pill-label {
            display: inline-block;
            cursor: pointer;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease-in-out;
            user-select: none;
        }

        .tag-pill-input:checked + .tag-pill-label {
            background-color: #fee2e2; /* red-100 */
            border-color: #d9534f;
            color: #1f2937; /* gray-800 */
            font-weight: 500;
        }

        .tag-pill-input:disabled + .tag-pill-label {
            background-color: #f3f4f6; /* gray-100 */
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
            border-color: #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="bg-white flex justify-center">
    <div class="max-w-3xl w-full px-4 sm:px-6 lg:px-8 py-16">
        <!-- Header -->
        <header class="pb-10 mb-10 border-b border-gray-200">
            <div class="flex items-start space-x-4">
                <a href="/"><img src="/logo.jpg" alt="Priyam Alok" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/334155?text=PA';"></a>
                <div class="flex-grow">
                    <div class="flex justify-between items-center">
                        <div><a href="/"><img src="/Capturelogo-removebg-preview.png" alt="Priyam Alok Title" class="h-8" onerror="this.onerror=null;this.src='https://placehold.co/200x40/ffffff/1a1a1a?text=Priyam+Alok';"></a></div>
                        <nav class="flex items-center space-x-6 text-base">
                            <a href="/" class="nav-link hidden sm:block text-lg">Home</a>
                            <a href="/project.html" class="nav-link hidden sm:block text-lg">Projects</a>
                            <a href="/blog.html" class="nav-link hidden sm:block text-lg">Musings</a>
                        </nav>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">Musings on insurance tech, finance<br>and life</p>
                </div>
            </div>
            <nav class="flex sm:hidden items-center justify-around space-x-4 text-base pt-6 border-t border-gray-200 mt-6">
                <a href="/" class="nav-link text-lg">Home</a>
                <a href="/project.html" class="nav-link text-lg">Projects</a>
                <a href="/blog.html" class="nav-link text-lg">Musings</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="text-base leading-relaxed text-gray-800">
            <section id="subscribe-section" class="mb-12">
                <h1 class="page-title text-3xl mb-4 text-black">Subscribe</h1>
                <p class="mb-8">Get new posts delivered to your inbox. Choose the topics you're interested in.</p>
                
                <form id="subscribe-form" class="space-y-6">
                    <!-- Email and Name Inputs -->
                    <div class="space-y-4">
                         <input type="email" id="email-input" placeholder="your.email@example.com" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-d9534f">
                         <input type="text" id="name-input" placeholder="Name (optional)" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-d9534f">
                    </div>

                    <!-- Tags Section -->
                    <div>
                        <p class="font-semibold mb-3 text-gray-700">Select your interests:</p>
                        <div id="all-toggle-container" class="flex flex-wrap gap-2 items-center mb-4">
                            <input type="checkbox" id="all-tags-toggle" class="hidden tag-pill-input">
                            <label for="all-tags-toggle" class="tag-pill-label">All</label>
                        </div>
                        <div id="tags-container" class="flex flex-wrap gap-2 pt-2 border-t border-gray-200">
                            <!-- Tags will be dynamically injected here -->
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-button" class="bg-d9534f text-white font-semibold px-8 py-3 rounded-md hover:bg-bf4340 transition-colors w-full sm:w-auto" style="background-color: #d9534f;">Subscribe</button>
                </form>
            </section>

            <!-- Thank You / Status Messages -->
            <section id="thank-you-section" class="hidden text-center py-16">
                <h2 class="text-2xl font-semibold text-black">Thank you for subscribing!</h2>
                <p class="text-gray-600 mt-2">Please check your inbox to confirm your subscription.</p>
            </section>
            <section id="error-section" class="hidden text-center py-16">
                <h2 class="text-2xl font-semibold text-red-600">Something went wrong</h2>
                <p id="error-message" class="text-gray-600 mt-2">Could not process your subscription. Please try again later.</p>
            </section>
        </main>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200 text-base text-gray-600">
            <p>Find me on <a href="https://www.linkedin.com/in/priyamalok/" target="_blank" rel="noopener noreferrer" class="link-style">linkedin</a>, <a href="https://x.com/priyam0k" target="_blank" rel="noopener noreferrer" class="link-style">twitter(x.com)</a></p>
        </footer>
    </div>

    <script src="post.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const tagsContainer = document.getElementById('tags-container');
        const subscribeForm = document.getElementById('subscribe-form');
        const subscribeSection = document.getElementById('subscribe-section');
        const thankYouSection = document.getElementById('thank-you-section');
        const errorSection = document.getElementById('error-section');
        const errorMessageEl = document.getElementById('error-message');
        const submitButton = document.getElementById('submit-button');
        const allTagsToggle = document.getElementById('all-tags-toggle');
        
        let allTagCheckboxes = [];
        let listUuidMap = {}; // This will be populated from Listmonk

        // --- Step 1: Fetch Lists from Listmonk and build the UI ---
        async function initializeForm() {
            try {
                // IMPORTANT: Replace with your actual Listmonk URL
                const listmonkApiUrl = 'http://localhost:9000/api/lists?per_page=999';
                const response = await fetch(listmonkApiUrl);

                if (!response.ok) {
                    throw new Error('Could not fetch lists from Listmonk. Ensure it is running and accessible.');
                }
                const data = await response.json();
                const lists = data.data.results;
                
                // Create a map of tag names to their UUIDs
                lists.forEach(list => {
                    listUuidMap[list.name] = list.uuid;
                });
                
                // Now build the tags UI
                buildTagsUI();

            } catch (error) {
                console.error("Initialization Error:", error);
                showError('Could not load subscription tags. Please refresh the page.');
                submitButton.disabled = true;
                submitButton.textContent = 'Unavailable';
                submitButton.style.backgroundColor = '#9ca3af';
            }
        }

        // --- Step 2: Build the tags on the page ---
        function buildTagsUI() {
            if (typeof posts !== 'undefined' && posts.length > 0) {
                const allTags = [...new Set(posts.flatMap(p => p.tags))].sort();
                
                allTags.forEach(tag => {
                    // Only create a checkbox if this tag exists as a list in Listmonk
                    if (listUuidMap[tag]) {
                        const id = `tag-${tag.replace(/\s+/g, '-')}`;

                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = id;
                        input.name = 'tags';
                        input.value = tag;
                        input.className = 'hidden tag-pill-input';

                        const label = document.createElement('label');
                        label.htmlFor = id;
                        label.textContent = tag;
                        label.className = 'tag-pill-label';

                        tagsContainer.appendChild(input);
                        tagsContainer.appendChild(label);
                    }
                });

                allTagCheckboxes = Array.from(document.querySelectorAll('input[name="tags"]'));
                setupTagLogic();
            }
        }

        // --- Step 3: Add logic for the "All" button ---
        function setupTagLogic() {
            allTagsToggle.addEventListener('change', () => {
                const isChecked = allTagsToggle.checked;
                allTagCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            });

            tagsContainer.addEventListener('change', (e) => {
                if (e.target.name === 'tags') {
                    const allChecked = allTagCheckboxes.every(checkbox => checkbox.checked);
                    allTagsToggle.checked = allChecked;
                }
            });
        }
        
        // --- Step 4: Handle Form Submission ---
        subscribeForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'Subscribing...';

            const name = document.getElementById('name-input').value;
            const email = document.getElementById('email-input').value;
            const selectedTags = allTagCheckboxes
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
            
            // Convert selected tag names to their corresponding UUIDs
            const selectedListUuids = selectedTags.map(tag => listUuidMap[tag]).filter(uuid => uuid);

            if (selectedListUuids.length === 0) {
                showError('Please select at least one interest.');
                return;
            }

            const payload = {
                email: email,
                name: name,
                list_uuids: selectedListUuids,
                status: "enabled"
            };

            try {
                // IMPORTANT: Replace with your actual Listmonk URL
                const subscribeApiUrl = 'http://localhost:9000/api/public/subscription';
                const response = await fetch(subscribeApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (response.ok) {
                    subscribeSection.classList.add('hidden');
                    thankYouSection.classList.remove('hidden');
                } else {
                    // Use the error message from Listmonk if available
                    throw new Error(result.message || 'Subscription failed. Please check your details.');
                }
            } catch (error) {
                console.error('Subscription Error:', error);
                showError(error.message);
            }
        });
        
        function showError(message) {
            errorMessageEl.textContent = message;
            subscribeSection.classList.add('hidden');
            thankYouSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
        }

        // --- Start the process ---
        initializeForm();
    });
    </script>
</body>
</html>

