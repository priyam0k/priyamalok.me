{{ define "main" }}
<main class="text-base leading-relaxed text-gray-800">
    <section class="mb-12">
        <h1 class="page-title text-3xl mb-4 text-black">{{ .Title }}</h1>
        <p class="mb-8">{{ .Description }}</p>
        
        <!-- The 'action' attribute is removed. JavaScript will handle the submission. -->
        <form id="subscription-form" class="space-y-6">
            <div class="space-y-4">
                <input id="email" type="email" name="email" required placeholder="your.email@example.com" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-d9534f">
                <input id="name" type="text" name="name" placeholder="Name (optional)" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-d9534f">
            </div>

            <div>
                <div class="flex justify-between items-center mb-3">
                    <p class="font-semibold text-gray-700">Select your interests:</p>
                    <button type="button" id="select-all-btn" class="tag-pill-label">Select All</button>
                </div>
                
                <div class="flex flex-wrap gap-3 pt-3 border-t border-gray-200">
                    <div><input id="39a14" type="checkbox" name="l" value="39a14a24-46c2-40ff-9b48-5e5679d7b7ae" class="hidden tag-pill-input"><label for="39a14" class="tag-pill-label">actuarial-exams</label></div>
                    <div><input id="b7b1c" type="checkbox" name="l" value="b7b1c94b-a763-42b7-8aa8-029ad9865f81" class="hidden tag-pill-input"><label for="b7b1c" class="tag-pill-label">blockchain</label></div>
                    <div><input id="a550a" type="checkbox" name="l" value="a550ab19-20f7-4e35-b225-efe617b67548" class="hidden tag-pill-input"><label for="a550a" class="tag-pill-label">cat-modeling</label></div>
                    <div><input id="4ac08" type="checkbox" name="l" value="4ac08855-c6f1-4b06-a-543-1cba6a2bc48b" class="hidden tag-pill-input"><label for="4ac08" class="tag-pill-label">climate-risk</label></div>
                    <div><input id="b0d98" type="checkbox" name="l" value="b0d98472-970e-424b-87af-10b0ff146680" class="hidden tag-pill-input"><label for="b0d98" class="tag-pill-label">economics</label></div>
                    <div><input id="03677" type="checkbox" name="l" value="03677794-e3d7-4384-8654-a2515eaa6a7e" class="hidden tag-pill-input"><label for="03677" class="tag-pill-label">finance</label></div>
                    <div><input id="f414b" type="checkbox" name="l" value="f414bf80-5e00-466a-8922-a227313f6746" class="hidden tag-pill-input"><label for="f414b" class="tag-pill-label">gbm</label></div>
                    <div><input id="c1412" type="checkbox" name="l" value="c1412719-89e2-4ddc-8719-26f35f39f279" class="hidden tag-pill-input"><label for="c1412" class="tag-pill-label">glm</label></div>
                    <div><input id="4a464" type="checkbox" name="l" value="4a464933-c610-45de-b9fe-f122b785fa2c" class="hidden tag-pill-input"><label for="4a464" class="tag-pill-label">glm vs gbm</label></div>
                    <div><input id="b9f2e" type="checkbox" name="l" value="b9f2e345-d1e6-49bc-9d04-5e522bd552ce" class="hidden tag-pill-input"><label for="b9f2e" class="tag-pill-label">intro</label></div>
                    <div><input id="39d7a" type="checkbox" name="l" value="39d7affb-1774-48a7-8a67-7fe5f335cf53" class="hidden tag-pill-input"><label for="39d7a" class="tag-pill-label">life</label></div>
                    <div><input id="bee24" type="checkbox" name="l" value="bee242cd-b54d-460a-8822-8f154d30aeee" class="hidden tag-pill-input"><label for="bee24" class="tag-pill-label">music</label></div>
                    <div><input id="63b37" type="checkbox" name="l" value="63b37789-b8f5-4bb5-a99b-843db350ea6f" class="hidden tag-pill-input"><label for="63b37" class="tag-pill-label">parametric-insurance</label></div>
                    <div><input id="a7306" type="checkbox" name="l" value="a73065f4-533d-4d58-a3ea-9fc53309f29b" class="hidden tag-pill-input"><label for="a7306" class="tag-pill-label">predictri</label></div>
                    <div><input id="7b925" type="checkbox" name="l" value="7b925f50-0ed1-49c7-b244-558f829432d1" class="hidden tag-pill-input"><label for="7b925" class="tag-pill-label">pricewriter</label></div>
                    <div><input id="6f979" type="checkbox" name="l" value="6f979711-0628-498f-977d-a01a5920c008" class="hidden tag-pill-input"><label for="6f979" class="tag-pill-label">pricing</label></div>
                    <div><input id="29d8f" type="checkbox" name="l" value="29d8fff5-2e90-4a29-80e0-8305e3699f22" class="hidden tag-pill-input"><label for="29d8f" class="tag-pill-label">project</label></div>
                    <div><input id="82e5a" type="checkbox" name="l" value="82e5a3db-6e88-4b06-b6c7-cce769be3027" class="hidden tag-pill-input"><label for="82e5a" class="tag-pill-label">reserving</label></div>
                </div>
            </div>
            
            <button type="submit" class="bg-d9534f text-white font-semibold px-8 py-3 rounded-md hover:bg-bf4340 transition-colors w-full sm:w-auto" style="background-color: #d9534f;">Subscribe</button>
        </form>

        <div id="message-container" class="mt-4"></div>
    </section>
</main>

<style>
    .tag-pill-label {
        display: inline-block;
        cursor: pointer;
        border: 1px solid #d1d5db;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.2s ease-in-out;
        user-select: none;
    }

    .tag-pill-input:checked + .tag-pill-label {
        background-color: #fee2e2;
        border-color: #d9534f;
        color: #1f2937;
        font-weight: 500;
    }
    
    #select-all-btn {
        background-color: #f3f4f6;
        color: #4b5563;
    }
    #select-all-btn:hover {
        background-color: #e5e7eb;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // === IMPORTANT: Make sure this URL is correct ===
    const LISTMONK_URL = "https://subscribe.ipriyam.com";
    // ===============================================

    const form = document.getElementById('subscription-form');
    const messageContainer = document.getElementById('message-container');

    form.addEventListener('submit', async (event) => {
        event.preventDefault(); // This stops the form from reloading the page
        
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.textContent;
        submitButton.textContent = 'Subscribing...';
        submitButton.disabled = true;
        messageContainer.innerHTML = '';

        // Collect data from the form
        const email = document.getElementById('email').value;
        const name = document.getElementById('name').value;
        const listCheckboxes = document.querySelectorAll('input[name="l"]:checked');
        const listUUIDs = Array.from(listCheckboxes).map(cb => cb.value);

        // Prepare the data payload for the API
        const payload = {
            email: email,
            name: name,
            lists: listUUIDs,
            status: "enabled",
            preconfirm_subscriptions: true
        };

        try {
            // Send data to the correct API endpoint
            const response = await fetch(`${LISTMONK_URL}/api/subscribers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'An unknown error occurred.');
            }
            
            // Show success message
            form.style.display = 'none';
            const heading = document.querySelector('.page-title');
            heading.textContent = "You're subscribed!";
            const subHeading = heading.nextElementSibling;
            subHeading.innerHTML = `Thank you! Please check your inbox to confirm your subscription.`;

        } catch (error) {
            console.error('Subscription failed:', error);
            messageContainer.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
        } finally {
            submitButton.textContent = originalButtonText;
            submitButton.disabled = false;
        }
    });

    // --- Select All / Deselect All Button Logic ---
    const selectAllBtn = document.getElementById('select-all-btn');
    const allTagCheckboxes = document.querySelectorAll('input[name="l"]');
    
    selectAllBtn.addEventListener('click', () => {
        const shouldSelectAll = !Array.from(allTagCheckboxes).every(cb => cb.checked);
        allTagCheckboxes.forEach(checkbox => { checkbox.checked = shouldSelectAll; });
        selectAllBtn.textContent = shouldSelectAll ? 'Deselect All' : 'Select All';
    });

    form.addEventListener('change', (e) => {
        if(e.target.name === 'l') {
             if (Array.from(allTagCheckboxes).every(cb => cb.checked)) {
                 selectAllBtn.textContent = 'Deselect All';
             } else {
                 selectAllBtn.textContent = 'Select All';
             }
        }
    });
});
</script>
{{ end }}